<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>0625-helper-managers - </title>
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body class="light">
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            document.body.className = theme;
            document.querySelector('html').className = theme + ' js';
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="affix"><a href="introduction.html">Introduction</a></li><li><a href="0001-transform-attribute-meta-parameter.html">0001-transform-attribute-meta-parameter</a></li><li><a href="0003-block-params.html">0003-block-params</a></li><li><a href="0003-cli-ember-doctor.html">0003-cli-ember-doctor</a></li><li><a href="0010-engines.html">0010-engines</a></li><li><a href="0011-improved-cp-syntax.html">0011-improved-cp-syntax</a></li><li><a href="0012-help-json-output.html">0012-help-json-output</a></li><li><a href="0015-the-road-to-ember-2-0.html">0015-the-road-to-ember-2-0</a></li><li><a href="0020-sri-default.html">0020-sri-default</a></li><li><a href="0023-command-line-completion.html">0023-command-line-completion</a></li><li><a href="0024-bound-attributes.html">0024-bound-attributes</a></li><li><a href="0028-app-import-output-file.html">0028-app-import-output-file</a></li><li><a href="0029-addon-black-and-whitelist-for-apps.html">0029-addon-black-and-whitelist-for-apps</a></li><li><a href="0045-internet-explorer.html">0045-internet-explorer</a></li><li><a href="0046-cli-improved-release-process.html">0046-cli-improved-release-process</a></li><li><a href="0046-registry-reform.html">0046-registry-reform</a></li><li><a href="0050-cli-production-code-stripping.html">0050-cli-production-code-stripping</a></li><li><a href="0050-improved-actions.html">0050-improved-actions</a></li><li><a href="0053-helpers.html">0053-helpers</a></li><li><a href="0055-anonymous-amd.html">0055-anonymous-amd</a></li><li><a href="0056-improved-release-cycle.html">0056-improved-release-cycle</a></li><li><a href="0057-ember-data-reference-unification.html">0057-ember-data-reference-unification</a></li><li><a href="0058-helper-listing.html">0058-helper-listing</a></li><li><a href="0061-ember-data-background-fetch.html">0061-ember-data-background-fetch</a></li><li><a href="0064-contextual-component-lookup.html">0064-contextual-component-lookup</a></li><li><a href="0065-deprecation-warning-handlers.html">0065-deprecation-warning-handlers</a></li><li><a href="0080-serve-file-api.html">0080-serve-file-api</a></li><li><a href="0086-firefox-in-ci.html">0086-firefox-in-ci</a></li><li><a href="0090-addon-tree-caching.html">0090-addon-tree-caching</a></li><li><a href="0091-cli-addon-instrumentation-experimental-hooks.html">0091-cli-addon-instrumentation-experimental-hooks</a></li><li><a href="0091-weakmap.html">0091-weakmap</a></li><li><a href="0092-blueprint-remove-old-files.html">0092-blueprint-remove-old-files</a></li><li><a href="0095-cli-standardise-targets.html">0095-cli-standardise-targets</a></li><li><a href="0095-router-service.html">0095-router-service</a></li><li><a href="0096-enable-yarn-usage.html">0096-enable-yarn-usage</a></li><li><a href="0101-ember-data-friendly-errors.html">0101-ember-data-friendly-errors</a></li><li><a href="0105-addons-optionalDependencies.html">0105-addons-optionalDependencies</a></li><li><a href="0108-add-custom-transform.html">0108-add-custom-transform</a></li><li><a href="0110-packaging.html">0110-packaging</a></li><li><a href="0114-add-template-lint-addon.html">0114-add-template-lint-addon</a></li><li><a href="0116-qunit-dom.html">0116-qunit-dom</a></li><li><a href="0120-cli-guides.html">0120-cli-guides</a></li><li><a href="0120-route-serializers.html">0120-route-serializers</a></li><li><a href="0121-remove-ember-cli-eslint.html">0121-remove-ember-cli-eslint</a></li><li><a href="0136-contains-to-includes.html">0136-contains-to-includes</a></li><li><a href="0139-isHtmlSafe.html">0139-isHtmlSafe</a></li><li><a href="0143-module-unification.html">0143-module-unification</a></li><li><a href="0150-factory-for.html">0150-factory-for</a></li><li><a href="0176-javascript-module-api.html">0176-javascript-module-api</a></li><li><a href="0178-deprecate-ember-k.html">0178-deprecate-ember-k</a></li><li><a href="0181-deprecate-ember-data-initializers.html">0181-deprecate-ember-data-initializers</a></li><li><a href="0186-track-unique-history-location-state.html">0186-track-unique-history-location-state</a></li><li><a href="0191-deprecate-component-lifecycle-hook-args.html">0191-deprecate-component-lifecycle-hook-args</a></li><li><a href="0194-deprecate-custom-event-manager.html">0194-deprecate-custom-event-manager</a></li><li><a href="0213-custom-components.html">0213-custom-components</a></li><li><a href="0225-ember-engines-mount-params.html">0225-ember-engines-mount-params</a></li><li><a href="0226-named-blocks.html">0226-named-blocks</a></li><li><a href="0229-deprecate-testing-restricted-resolver.html">0229-deprecate-testing-restricted-resolver</a></li><li><a href="0232-simplify-qunit-testing-api.html">0232-simplify-qunit-testing-api</a></li><li><a href="0236-deprecation-ember-string.html">0236-deprecation-ember-string</a></li><li><a href="0237-deprecation-ember-map.html">0237-deprecation-ember-map</a></li><li><a href="0240-es-classes.html">0240-es-classes</a></li><li><a href="0252-browser-support-changes.html">0252-browser-support-changes</a></li><li><a href="0268-acceptance-testing-refactor.html">0268-acceptance-testing-refactor</a></li><li><a href="0272-deprecation-native-function-prototype-extensions.html">0272-deprecation-native-function-prototype-extensions</a></li><li><a href="0276-named-args.html">0276-named-args</a></li><li><a href="0278-template-only-components.html">0278-template-only-components</a></li><li><a href="0280-remove-application-wrapper.html">0280-remove-application-wrapper</a></li><li><a href="0281-es5-getters.html">0281-es5-getters</a></li><li><a href="0286-block-let-template-helper.html">0286-block-let-template-helper</a></li><li><a href="0287-promote-in-element-to-public-api.html">0287-promote-in-element-to-public-api</a></li><li><a href="0293-record-data.html">0293-record-data</a></li><li><a href="0294-optional-jquery.html">0294-optional-jquery</a></li><li><a href="0297-deprecate-ember-logger.html">0297-deprecate-ember-logger</a></li><li><a href="0300-rfc-process-update.html">0300-rfc-process-update</a></li><li><a href="0308-deprecate-property-lookup-fallback.html">0308-deprecate-property-lookup-fallback</a></li><li><a href="0311-angle-bracket-invocation.html">0311-angle-bracket-invocation</a></li><li><a href="0318-array-helper.html">0318-array-helper</a></li><li><a href="0322-deprecate-copy-copyable.html">0322-deprecate-copy-copyable</a></li><li><a href="0324-deprecate-component-isvisible.html">0324-deprecate-component-isvisible</a></li><li><a href="0326-ember-data-filter-deprecation.html">0326-ember-data-filter-deprecation</a></li><li><a href="0329-deprecated-ember-evented-in-ember-data.html">0329-deprecated-ember-evented-in-ember-data</a></li><li><a href="0331-deprecate-globals-resolver.html">0331-deprecate-globals-resolver</a></li><li><a href="0332-ember-data-record-links-and-meta.html">0332-ember-data-record-links-and-meta</a></li><li><a href="0335-deprecate-send-action.html">0335-deprecate-send-action</a></li><li><a href="0337-native-class-constructor-update.html">0337-native-class-constructor-update</a></li><li><a href="0340-deprecate-ember-merge.html">0340-deprecate-ember-merge</a></li><li><a href="0345-discord.html">0345-discord</a></li><li><a href="0364-roadmap-2018.html">0364-roadmap-2018</a></li><li><a href="0369-deprecate-computed-clobberability.html">0369-deprecate-computed-clobberability</a></li><li><a href="0370-deprecate-computed-volatile.html">0370-deprecate-computed-volatile</a></li><li><a href="0372-ember-data-model-factory-for.html">0372-ember-data-model-factory-for</a></li><li><a href="0373-Element-Modifier-Managers.html">0373-Element-Modifier-Managers</a></li><li><a href="0375-deprecate-computed-property-modifier.html">0375-deprecate-computed-property-modifier</a></li><li><a href="0386-remove-jquery.html">0386-remove-jquery</a></li><li><a href="0389-dynamic-tag-names.html">0389-dynamic-tag-names</a></li><li><a href="0391-router-helpers.html">0391-router-helpers</a></li><li><a href="0392-deprecate-component-manager-string-lookup.html">0392-deprecate-component-manager-string-lookup</a></li><li><a href="0395-ember-data-packages.html">0395-ember-data-packages</a></li><li><a href="0398-RouteInfo-Metadata.html">0398-RouteInfo-Metadata</a></li><li><a href="0403-ember-data-identifiers.html">0403-ember-data-identifiers</a></li><li><a href="0408-decorators.html">0408-decorators</a></li><li><a href="0410-tracked-properties.html">0410-tracked-properties</a></li><li><a href="0415-render-element-modifiers.html">0415-render-element-modifiers</a></li><li><a href="0416-glimmer-components.html">0416-glimmer-components</a></li><li><a href="0418-deprecate-route-render-methods.html">0418-deprecate-route-render-methods</a></li><li><a href="0421-deprecate-application-controller-props.html">0421-deprecate-application-controller-props</a></li><li><a href="0425-website-redesign.html">0425-website-redesign</a></li><li><a href="0431-guides-restructure.html">0431-guides-restructure</a></li><li><a href="0432-contextual-helpers.html">0432-contextual-helpers</a></li><li><a href="0435-modifier-splattributes.html">0435-modifier-splattributes</a></li><li><a href="0440-decorator-support.html">0440-decorator-support</a></li><li><a href="0445-deprecate-with.html">0445-deprecate-with</a></li><li><a href="0446-contribution-guides.html">0446-contribution-guides</a></li><li><a href="0449-deprecate-partials.html">0449-deprecate-partials</a></li><li><a href="0451-injection-parameter-normalization.html">0451-injection-parameter-normalization</a></li><li><a href="0452-ember-data-medium-term-plan.html">0452-ember-data-medium-term-plan</a></li><li><a href="0457-nested-lookups.html">0457-nested-lookups</a></li><li><a href="0459-angle-bracket-built-in-components.html">0459-angle-bracket-built-in-components</a></li><li><a href="0460-yieldable-named-blocks.html">0460-yieldable-named-blocks</a></li><li><a href="0461-ember-data-singleton-record-data.html">0461-ember-data-singleton-record-data</a></li><li><a href="0463-record-data-state.html">0463-record-data-state</a></li><li><a href="0465-record-data-errors.html">0465-record-data-errors</a></li><li><a href="0466-request-state-service.html">0466-request-state-service</a></li><li><a href="0468-classic-decorator.html">0468-classic-decorator</a></li><li><a href="0470-fn-helper.html">0470-fn-helper</a></li><li><a href="0471-on-modifier.html">0471-on-modifier</a></li><li><a href="0477-blueprints-update.html">0477-blueprints-update</a></li><li><a href="0478-tracked-properties-updates.html">0478-tracked-properties-updates</a></li><li><a href="0481-component-templates-co-location.html">0481-component-templates-co-location</a></li><li><a href="0486-deprecate-mouseenter.html">0486-deprecate-mouseenter</a></li><li><a href="0487-custom-model-classes.html">0487-custom-model-classes</a></li><li><a href="0491-deprecate-disconnect-outlet.html">0491-deprecate-disconnect-outlet</a></li><li><a href="0494-async-observers.html">0494-async-observers</a></li><li><a href="0496-handlebars-strict-mode.html">0496-handlebars-strict-mode</a></li><li><a href="0507-embroider-v2-package-format.html">0507-embroider-v2-package-format</a></li><li><a href="0519-2019-2020-roadmap.html">0519-2019-2020-roadmap</a></li><li><a href="0521-find-by-identifier.html">0521-find-by-identifier</a></li><li><a href="0522-default-serializers-and-adapters.html">0522-default-serializers-and-adapters</a></li><li><a href="0523-model-argument-for-route-templates.html">0523-model-argument-for-route-templates</a></li><li><a href="0554-deprecate-getwithdefault.html">0554-deprecate-getwithdefault</a></li><li><a href="0558-edition-detection.html">0558-edition-detection</a></li><li><a href="0580-destroyables.html">0580-destroyables</a></li><li><a href="0581-new-test-waiters.html">0581-new-test-waiters</a></li><li><a href="0585-improved-ember-registry-apis.html">0585-improved-ember-registry-apis</a></li><li><a href="0615-autotracking-memoization.html">0615-autotracking-memoization</a></li><li><a href="0617-rfc-stages.html">0617-rfc-stages</a></li><li><a href="0625-helper-managers.html" class="active">0625-helper-managers</a></li><li><a href="0626-invoke-helper.html">0626-invoke-helper</a></li><li><a href="0628-prettier.html">0628-prettier</a></li><li><a href="0631-refresh-method-for-router-service.html">0631-refresh-method-for-router-service</a></li><li><a href="0635-ember-new-lang.html">0635-ember-new-lang</a></li><li><a href="0637-customizable-test-setups.html">0637-customizable-test-setups</a></li><li><a href="0638-interactive-app-creation.html">0638-interactive-app-creation</a></li><li><a href="0639-replace-blacklist-whitelist.html">0639-replace-blacklist-whitelist</a></li><li><a href="0645-add-ember-page-title-addon.html">0645-add-ember-page-title-addon</a></li><li><a href="0649-deprecation-staging.html">0649-deprecation-staging</a></li><li><a href="0659-unique-id-helper.html">0659-unique-id-helper</a></li><li><a href="0671-modernize-built-in-components-1.html">0671-modernize-built-in-components-1</a></li><li><a href="0673-deprecate-tryinvoke.html">0673-deprecate-tryinvoke</a></li><li><a href="0674-deprecate-transition-methods-of-controller-and-route.html">0674-deprecate-transition-methods-of-controller-and-route</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar" class="menu-bar">
                    <div id="menu-bar-sticky-container">
                        <div class="left-buttons">
                            <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                                <i class="fa fa-bars"></i>
                            </button>
                            <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                                <i class="fa fa-paint-brush"></i>
                            </button>
                            <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                                <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                            </ul>
                            
                            <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                                <i class="fa fa-search"></i>
                            </button>
                            
                        </div>

                        <h1 class="menu-title"></h1>

                        <div class="right-buttons">
                            <a href="print.html" title="Print this book" aria-label="Print this book">
                                <i id="print-button" class="fa fa-print"></i>
                            </a>
                            
                        </div>
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <hr />
<p>Start Date: 2020-04-28
Relevant Team(s): Ember.js
RFC PR: https://github.com/emberjs/rfcs/pull/625</p>
<hr />
<h1><a class="header" href="#helper-managers" id="helper-managers">Helper Managers</a></h1>
<h2><a class="header" href="#summary" id="summary">Summary</a></h2>
<p>Provides a low-level primitive for defining helpers.</p>
<h2><a class="header" href="#motivation" id="motivation">Motivation</a></h2>
<p>Helpers are a valuable template construct in Ember. They have a number of
benefits that come from having their lifecycle being managed by the template and
container, including:</p>
<ol>
<li>
<p>Behavior can be <em>self-contained</em>. Some APIs need to run at multiple points in
time based on a template's lifecycle, such as for a plugin that needs to be setup
on initialization and torn down upon destruction. Doing this in components
via lifecycle hooks usually forces users to split their API across multiple
touch points in a component, which requires a lot of boilerplate and can make
it difficult to understand how the whole system works together. Helpers
provide a way for these shared concerns to be contained in a single location.</p>
</li>
<li>
<p>It doesn't require <em>multiple inheritance</em>. Alternatives for sharing behaviors
that touch multiple parts of the lifecycle such as mixins and strategies like
them create complicated inheritance hierarchies that can be difficult to debug.
Helpers do not insert themselves into the inheritance hierarchy of a class,
they are children of the template instead, which is much easier to reason
about in practice.</p>
</li>
<li>
<p>They are highly <em>composable</em>. Helpers, like components, can be used multiple
times in a template and can be used within <code>{{if}}</code> and <code>{{each}}</code> blocks.
Combined with their ability to be hold a self contained lifecycle, this makes
them a powerful tool for composing declarative behavior.</p>
</li>
<li>
<p>They can be <em>destroyed</em>. They tie in naturally to the destruction APIs that
we have recently added to Ember, and that allows their lifecycle to be
managed in a self contained way.</p>
</li>
</ol>
<p>Helpers are currently the only template construct in Ember that do not have a
low-level primitive that is public. With components and modifiers, users can define
component managers and modifier managers respectively to create their own high
level APIs, but for helpers the only option currently is to use the high level
<code>helper()</code> wrapper function, or the <code>Helper</code> base class.</p>
<p>These APIs are beginning to show their age in Ember Octane, and unlocking
experimentation via a helper manager would allow us to begin designing a new
generation of helpers. Some possible areas to explore here would include:</p>
<ul>
<li>Using a native base class for helpers, instead of <code>EmberObject</code></li>
<li>Adding lifecycle hooks, similar to modifiers, to class-based helpers</li>
<li>Adding the ability to inject services to functional helpers</li>
<li>Allowing normal functions to operate as helpers</li>
</ul>
<p>In addition, it would allow us to begin adding new functionality to helpers via
manager capabilities. This RFC proposes one such capability, <code>hasScheduledEffect</code>.</p>
<h3><a class="header" href="#effect-helpers" id="effect-helpers">Effect Helpers</a></h3>
<p>Usually, template helpers are supposed to return a value. However, if a helper
returns <code>undefined</code> and rendered in a template, it will produce no output. This
can be used to accomplish a <em>side-effect</em>:</p>
<pre><code class="language-js">// app/helpers/title.js
export default helper(([title]) =&gt; {
  window.document.title = title;
});
</code></pre>
<pre><code class="language-hbs">{{title &quot;My Document Title&quot;}}
</code></pre>
<p>Addons such as <a href="https://github.com/adopted-ember-addons/ember-page-title">ember-page-title</a>
use this to make helpers that can be added to the template to specify
<em>app behavior</em> declaratively. This is a much better way to approach certain
types of behavior and APIs, compared to the alternative of using mixins and
lifecycle hooks to manage them.</p>
<p>However, this pattern has some issues today, mostly stemming from the fact that
they execute <em>during</em> render, which is not an ideal time for side-effecting.
They can also be abused to modify app state, which can lead to difficult to
follow code paths reminiscent of observers. These issues stem from a mismatch
between two different goals, the goal of calculating a result or value, and the
goal of triggering side-effects.</p>
<p>The <code>hasScheduledEffect</code> capability would schedule side-effecting helpers to execute
<em>after</em> render, and would <em>disable</em> Ember's state mutations while they were
running. This would ensure that side-effecting helpers run at the optimal time,
and do not enable antipatterns and complicated codepaths.</p>
<h2><a class="header" href="#detailed-design" id="detailed-design">Detailed design</a></h2>
<p>This RFC proposes adding the <code>setHelperManager</code> and <code>capabilities</code> APIs,
imported from <code>@ember/helper</code>. Like <code>setComponentManager</code> and
<code>setModifierManager</code>, <code>setHelperManager</code> receives a callback that is passed
the owner, and returns an instance of the helper manager. When a helper
definition is resolved by Ember, it will look up the manager recursively on the
definition's prototype chain until it finds a helper manager. If it does not
find one, it will throw an error.</p>
<pre><code class="language-ts">// object is used here to mean any valid WeakMap key
type HelperDefinition = object;

export declare function setHelperManager(
  factory: (owner: Owner) =&gt; HelperManager,
  definition: HelperDefinition
): HelperDefinition;
</code></pre>
<p>And like the <code>capabilities</code> functions for component and modifier managers, the
<code>capabilities</code> function for helper managers receives a version string as the
first parameter and a options object as the second with optional flags as
booleans. It produces an opaque <code>HelperCapabilities</code> object, which is assigned
to the helper manager.</p>
<pre><code class="language-ts">interface HelperCapabilitiesOptions {
  hasValue?: boolean;
  hasDestroyable?: boolean;
  hasScheduledEffect?: boolean;
}

type HelperCapabilities = Opaque;

export declare function capabilities(
  // to be replaced with the version of Ember this lands in
  version: '3.21.0',
  options: HelperCapabilitiesOptions
): HelperCapabilities;
</code></pre>
<p>Helper managers themselves have the following interface:</p>
<pre><code class="language-ts">interface HelperManager&lt;HelperStateBucket&gt; {
  capabilities: HelperCapabilities;

  createHelper(definition: HelperDefinition, args: TemplateArgs): HelperStateBucket;

  getValue?(bucket: HelperStateBucket): unknown;

  runEffect?(bucket: HelperStateBucket): void;

  getDestroyable?(bucket: HelperStateBucket): object;
}
</code></pre>
<p>Let's dig into these hooks one by one:</p>
<h3><a class="header" href="#hooks" id="hooks">Hooks</a></h3>
<h4><a class="header" href="#createhelper" id="createhelper"><code>createHelper</code></a></h4>
<p><code>createHelper</code> is a required hook on the HelperManager interface. The hook is
passed the definition of the helper that is currently being created, and is
expected to return a <em>state bucket</em>. This state bucket is what represents the
current state of the helper, and will be passed to the other lifecycle hooks at
appropriate times. It is not necessarily related to the definition of the
helper itself - for instance, you could return an object <em>containing</em> an
instance of the helper:</p>
<pre><code class="language-js">class MyManager {
  createHelper(Definition, args) {
    return {
      instance: new Definition(args);
    };
  }
}
</code></pre>
<p>This allows the manager to store metadata that it doesn't want to expose to the
user.</p>
<p>This hook is <em>not</em> autotracked - changes to tracked values used within this hook
will <em>not</em> result in a call to any of the other lifecycle hooks. This is because
it is unclear what should happen if it invalidates, and rather than make a
decision at this point, the initial API is aiming to allow as much expressivity
as possible. This could change in the future with changes to capabilities and
their behaviors.</p>
<p>If users do want to autotrack some values used during construction, they can
either create the instance of the helper in <code>runEffect</code> or <code>getValue</code>, or they
can use the <code>cache</code> API to autotrack the <code>createHelper</code> hook themselves. This
provides maximum flexibility and expressiveness to manager authors.</p>
<p>This hook has the following timing semantics:</p>
<p><strong>Always</strong></p>
<ul>
<li>called as discovered during DOM construction</li>
<li>called in definition order in the template</li>
</ul>
<h4><a class="header" href="#getvalue" id="getvalue"><code>getValue</code></a></h4>
<p><code>getValue</code> is an optional hook that should return the value of the helper. This
is the value that is returned from the helper and passed into the template.</p>
<p>This hook is called when the value is requested from the helper (e.g. when the
template is rendering and the helper value is needed). The hook is autotracked,
and will rerun whenever any tracked values used inside of it are updated.
Otherwise it does not rerun.</p>
<blockquote>
<p>Note: This means that arguments which are not <em>consumed</em> within the hook will
not trigger updates.</p>
</blockquote>
<p>This hook is only called for helpers with the <code>hasValue</code> capability enabled.
This hook has the following timing semantics:</p>
<p><strong>Always</strong></p>
<ul>
<li>called the first time the helper value is requested</li>
<li>called after autotracked state has changed</li>
</ul>
<p><strong>Never</strong></p>
<ul>
<li>called if the <code>hasValue</code> capability is disabled</li>
</ul>
<h4><a class="header" href="#runeffect" id="runeffect"><code>runEffect</code></a></h4>
<p><code>runEffect</code> is an optional hook that should run the effect that the helper is
applying, setting it up or updating it.</p>
<p>This hook is scheduled to be called some time after render and prior to paint.
There is not a guaranteed, 1-to-1 relationship between a render pass and this
hook firing. For instance, multiple render passes could occur, and the hook may
only trigger once. It may also never trigger if it was dirtied in one render
pass and then destroyed in the next.</p>
<p>The hook is autotracked, and will rerun whenever any tracked values used inside
of it are updated. Otherwise it does not rerun.</p>
<p>The hook is also run during a time period where state mutations are <em>disabled</em>
in Ember. Any tracked state mutation will throw an error during this time,
including changes to tracked properties, changes made using <code>Ember.set</code>, updates
to computed properties, etc. This is meant to prevent infinite rerenders and
other antipatterns.</p>
<p>This hook is only called for helpers with the <code>hasScheduledEffect</code> capability
enabled. This hook is also not called in SSR currently, though this could be
added as a capability in the future. It has the following timing semantics:</p>
<p><strong>Always</strong></p>
<ul>
<li>called after the helper was first created, if the helper has not been
destroyed since creation</li>
<li>called after autotracked state has changed, if the helper has not been
destroyed during render</li>
</ul>
<p><strong>Never</strong></p>
<ul>
<li>called if the <code>hasScheduledEffect</code> capability is disabled</li>
<li>called in SSR</li>
</ul>
<h4><a class="header" href="#getdestroyable" id="getdestroyable"><code>getDestroyable</code></a></h4>
<p><code>getDestroyable</code> is an optional hook that users can use to register a
destroyable object for the helper. This destroyable will be registered to the
containing block or template parent, and will be destroyed when it is destroyed.
See the <a href="https://github.com/emberjs/rfcs/blob/master/text/0580-destroyables.md">Destroyables RFC</a>
for more details.</p>
<p><code>getDestroyable</code> is only called if the <code>hasDestroyable</code> capability is enabled.</p>
<p>This hook has the following timing semantics:</p>
<p><strong>Always</strong></p>
<ul>
<li>called immediately after the <code>createHelper</code> hook is called</li>
</ul>
<p><strong>Never</strong></p>
<ul>
<li>called if the <code>hasDestroyable</code> capability is disabled</li>
</ul>
<h3><a class="header" href="#capabilities" id="capabilities">Capabilities</a></h3>
<p>There are three proposed capabilities for helper managers:</p>
<ul>
<li><code>hasDestroyable</code></li>
<li><code>hasValue</code></li>
<li><code>hasScheduledEffect</code></li>
</ul>
<p>Out of these capabilities, one of <code>hasScheduledEffect</code> or <code>hasValue</code> <em>must</em> be
enabled. The other must <em>not</em> be enabled, meaning they are mutually exclusive.</p>
<h4><a class="header" href="#hasdestroyable" id="hasdestroyable"><code>hasDestroyable</code></a></h4>
<ul>
<li>Default value: false</li>
</ul>
<p>Determines if the helper has a destroyable to include in the destructor
hierarchy. If enabled, the <code>getDestroyable</code> hook will be called, and its result
will be associated with the destroyable parent block.</p>
<h4><a class="header" href="#hasvalue" id="hasvalue"><code>hasValue</code></a></h4>
<ul>
<li>Default value: false</li>
</ul>
<p>Determines if the helper has a value which can be used externally. The helper's
<code>getValue</code> hook will be run whenever the value of the helper is accessed if this
capability is enabled.</p>
<h4><a class="header" href="#hasscheduledeffect" id="hasscheduledeffect"><code>hasScheduledEffect</code></a></h4>
<ul>
<li>Default value: false</li>
</ul>
<p>Determines if the helper has a scheduled effect. If enabled, the helper's
<code>runEffect</code> hook will run after render, and will not allow any type of state
mutation when running.</p>
<h3><a class="header" href="#scheduled-helpers-timing" id="scheduled-helpers-timing">Scheduled Helpers Timing</a></h3>
<p>Scheduled helpers run their effects after render, and after modifiers have been
applied for a given render, but before paint. The exact timing may shift around,
and may or may not correspond to a single rendering pass in cases where there
are multiple rendering passes in a single paint.</p>
<p>In the future different timings may be added as options for scheduling. For
instance, a timing to call the effect using <code>requestIdleCallback</code>, when the
browser has finished rendering and handling higher priority work, could be
added. However, this is out of scope for this RFC.</p>
<h2><a class="header" href="#how-we-teach-this" id="how-we-teach-this">How we teach this</a></h2>
<p>Helper managers are a low-level construct that is generally only meant to be
used by experts and addon authors. As such, it will only be taught through API
documentation. In addition, for precision and clarity, the API docs will include
snippets of TypeScript interfaces where appropriate.</p>
<h3><a class="header" href="#api-docs" id="api-docs">API Docs</a></h3>
<h4><a class="header" href="#sethelpermanager" id="sethelpermanager"><code>setHelperManager</code></a></h4>
<p>Sets the helper manager for an object or function.</p>
<pre><code class="language-js">setHelperManager((owner) =&gt; new ClassHelperManager(owner), Helper)
</code></pre>
<p>When a value is used as a helper in a template, the helper manager is looked up
on the object by walking up its prototype chain and finding the first helper
manager. This manager then receives the value and can create and manage an
instance of a helper from it. This provides a layer of indirection that allows
users to design high-level helper APIs, without Ember needing to worry about the
details. High-level APIs can be experimented with and iterated on while the
core of Ember helpers remains stable, and new APIs can be introduced gradually
over time to existing code bases.</p>
<p><code>setHelperManager</code> receives two arguments:</p>
<ol>
<li>A factory function, which receives the <code>owner</code> and returns an instance of a
helper manager.</li>
<li>A helper definition, which is the object or function to associate the factory function with.</li>
</ol>
<p>The first time the object is looked up, the factory function will be called to
create the helper manager. It will be cached, and in subsequent lookups the
cached helper manager will be used instead.</p>
<p>Only one helper manager is guaranteed to exist per <code>owner</code> and per usage of
<code>setHelperManager</code>, so many helpers will end up using the same instance of the
helper manager. As such, you should only store state that is related to the
manager itself. If you want to store state specific to a particular helper
definition, you should assign a unique helper manager to that helper. In
general, most managers should either be stateless, or only have the <code>owner</code> they
were created with as state.</p>
<p>Helper managers must fulfill the following interface (This example uses
<a href="https://www.typescriptlang.org/docs/handbook/interfaces.html">TypeScript interfaces</a>
for precision, you do not need to write helper managers using TypeScript):</p>
<pre><code class="language-ts">interface HelperManager&lt;HelperStateBucket&gt; {
  capabilities: HelperCapabilities;

  createHelper(definition: HelperDefinition, args: TemplateArgs): HelperStateBucket;

  getValue?(bucket: HelperStateBucket): unknown;

  runEffect?(bucket: HelperStateBucket): void;

  getDestroyable?(bucket: HelperStateBucket): object;
}
</code></pre>
<p>The capabilities property <em>must</em> be provided using the <code>capabilities()</code> function
imported from the same module as <code>setHelperManager</code>:</p>
<pre><code class="language-js">import { capabilities } from '@ember/helper';

class MyHelperManager {
  capabilities = capabilities('3.21.0', { hasValue: true });

  // ...snip...
}
</code></pre>
<p>Below is a description of each of the methods on the interface and their
functions.</p>
<blockquote>
<p>The remaining API docs should be copied from the descriptions in the Detailed
Design section of this RFC.</p>
</blockquote>
<h4><a class="header" href="#capabilities-1" id="capabilities-1"><code>capabilities</code></a></h4>
<p><code>capabilities</code> returns a capabilities configuration which can be used to modify
the behavior of the manager. Manager capabilities <em>must</em> be provided using the
<code>capabilities</code> function, as the underlying implementation can change over time.</p>
<p>The first argument to capabilities is a version string, which is the version of
Ember that the capabilities were defined in. Ember can add new versions at any
time, and these may have entirely different behaviors, but it will not remove
old versions until the next major version.</p>
<pre><code class="language-js">capabilities('3.x');
</code></pre>
<p>The second argument is an object of capabilities and boolean values indicating
whether they are enabled or disabled.</p>
<pre><code class="language-js">capabilities('3.x', {
  hasValue: true,
  hasDestructor: true,
});
</code></pre>
<p>If no value is specified, then the default value will be used.</p>
<h5><a class="header" href="#3x-capabilities" id="3x-capabilities"><code>3.x</code> capabilities</a></h5>
<blockquote>
<p>The remaining API docs should be copied from the descriptions in the Detailed
Design section of this RFC. 3.x above should be replaced with the version that
helper managers are initially released in.</p>
</blockquote>
<h2><a class="header" href="#drawbacks" id="drawbacks">Drawbacks</a></h2>
<ul>
<li>Adds a layer of indirection to helpers, which could add to complexity and
cost in terms of performance. This isn't likely, as we haven't seen this
happen with other managers we've introduced.</li>
</ul>
<h2><a class="header" href="#alternatives" id="alternatives">Alternatives</a></h2>
<ul>
<li>
<p>We could continue using the current helper APIs, and try to incrementally
migrate them to only use native classes. This wouldn't match the strategy
we've taken with other template constructs, like components and modifiers, and
would result in less ability for the community to experiment and less
flexibility if we chose to change helpers again in the future.</p>
</li>
<li>
<p>The <code>hasScheduledEffect</code> capability could be broken out into a separate RFC.
It is mostly separable, except for the impact it has on <code>getValue</code>. Value-less
and effect-less helpers don't really make sense, so in isolation <code>getValue</code>
would probably not be an optional hook, and the <code>hasValue</code> capability wouldn't
exist.</p>
<p>Capabilities can change from version to version, so this is still not a major
issue, but it seems like it would be easier to add from the get go.</p>
</li>
</ul>
<h2><a class="header" href="#appendix" id="appendix">Appendix</a></h2>
<h3><a class="header" href="#implementation-of-current-helper-apis" id="implementation-of-current-helper-apis">Implementation of Current Helper APIs</a></h3>
<p>The following is an implementation of the current helper APIs using this manager
API. There are two separate managers, one for class based helpers and one for
functional helpers:</p>
<pre><code class="language-js">import EmberObject from '@ember/object';
import { tracked } from '@glimmer/tracking';
import { setHelperManager, capabilities } from '@ember/helper';

const RECOMPUTE = symbol();

export class Helper extends EmberObject {
  @tracked [RECOMPUTE];

  constructor(...args) {
    super(...args);

    registerDestructor(this, () =&gt; this.destroy());
  }

  recompute() {
    // update the value to force a recompute
    this[RECOMPUTED] = undefined;
  }
}

class ClassHelperManager {
  capabilities = capabilities({
    hasValue: true,
    hasDestroyable: true,
  });

  ownerInjection = {};

  constructor(owner) {
    setOwner(this.ownerInjection, owner);
  }

  createHelper(Definition, args) {
    let helper = Definition.create(this.ownerInjection);

    return { helper, args };
  }

  getValue({ helper, args }) {
    // Consume the RECOMPUTE tag, so if anyone ever
    // calls recompute() it'll force a recompute
    helper[RECOMPUTE];

    return helper.compute(args.positional, args.named);
  }

  getDestroyable({ helper }) {
    return helper;
  }
}

setHelperManager((owner) =&gt; new ClassHelperManager(owner), Helper.prototype);
</code></pre>
<pre><code class="language-js">import { tracked } from '@glimmer/tracking';
import { setHelperManager, capabilities } from '@ember/helper';

class FunctionalHelperManager {
  capabilities = capabilities({
    hasValue: true,
  });

  createHelper(fn, args) {
    return { fn, args };
  }

  getValue({ fn, args }) {
    return fn(args.positional, args.named);
  }
}

const FUNCTIONAL_HELPER_MANAGER = () =&gt; new FunctionalHelperManager();

export function helper(fn) {
  setHelperManager(FUNCTIONAL_HELPER_MANAGER, fn);

  return fn;
}
</code></pre>
<h3><a class="header" href="#implementation-of-ember-page-title-using-effects" id="implementation-of-ember-page-title-using-effects">Implementation of Ember Page Title using Effects</a></h3>
<p>This adapts the <a href="https://adopted-ember-addons.github.io/ember-page-title/">ember-page-title</a>
addon to use the implementation proposed in this RFC. The biggest change to the
public API is that using <code>push</code> and <code>remove</code> directly schedules updates to the
title, so they can in theory be made public. The scheduling could also be moved
back to the helper itself to avoid that issue, this just cleans it up.</p>
<pre><code class="language-js">// ember-page-title/addon/services/page-title-list

import Service, { inject as service } from '@ember/service';
import { getOwner } from '@ember/application';
import { scheduleOnce } from '@ember/run';

export default class PageTitleListService extends Service {
  @service headData;

  tokens = [];

  /**
    The default separator to use between tokens.
    @property defaultSeparator
    @default ' | '
   */
  defaultSeparator = ' | ';

  /**
    The default prepend value to use.
    @property defaultPrepend
    @default true
   */
  defaultPrepend = true;

  /**
    The default replace value to use.
    @property defaultReplace
    @default null
   */
  defaultReplace = null;

  constructor(owner) {
    super(owner);
    this._removeExistingTitleTag();

    let config = getOwner(this).resolveRegistration('config:environment');
    if (config.pageTitle) {
      ['separator', 'prepend', 'replace'].forEach((key) =&gt; {
        if (isPresent(config.pageTitle[key])) {
          set(this, `default${capitalize(key)}`, config.pageTitle[key]);
        }
      });
    }
  }

  applyTokenDefaults(token) {
    let {
      defaultSeparator,
      defaultPrepend,
      defaultReplace,
    } = this

    if (token.separator == null) {
      token.separator = defaultSeparator;
    }

    if (token.prepend == null &amp;&amp; defaultPrepend != null) {
      token.prepend = defaultPrepend;
    }

    if (token.replace == null &amp;&amp; defaultReplace != null) {
      token.replace = defaultReplace;
    }
  }

  inheritFromPrevious(token) {
    let { previous } = token;

    if (previous) {
      if (token.separator == null) {
        token.separator = previous.separator;
      }

      if (token.prepend == null) {
        token.prepend = previous.prepend;
      }
    }
  }

  push(token) {
    let { tokens } = this;
    let tokenForIdIndex = tokens.findIndex(({ id }), token.id === id);

    if (tokenForIdIndex) {
      let tokenForId = tokens[tokenForIdIndex];
      let { previous, next } = tokenForId;

      token.previous = previous;
      token.next = next;

      this.inheritFromPrevious(token);
      this.applyTokenDefaults(token);

      tokens.splice(tokenForIdIndex, 1, token);
      return;
    }

    let previous = tokens.slice(-1)[0];
    if (previous) {
      token.previous = previous;
      previous.next = token;
      this.inheritFromPrevious(token);
    }

    this.applyTokenDefaults(token);

    tokens.push(token);

    scheduleOnce('actions', this, this.updateTitle);
  }

  remove(id) {
    let { tokens } = this;

    let tokenIndex = tokens.findIndex(({ id }), token.id === id);
    let token = tokens[tokenIndex];
    let { next, previous } = token;

    if (next) {
      next.previous = previous;
    }

    if (previous) {
      previous.next = next;
    }

    token.previous = token.next = null;
    tokens.splice(tokenIndex, 1);

    scheduleOnce('actions', this, this.updateTitle);
  }

  updateTitle() {
    if (this.isDestroying || this.isDestroyed) return;

    this.headData.set('title', this.toString());
  }

  get visibleTokens() {
    let { tokens } = this;

    let replaceIndex = tokens.length;

    while (replaceIndex--) {
      if (tokens[replaceIndex].replace) {
        break;
      }
    }

    return tokens.slice(replaceIndex - 1);
  }

  get sortedTokens() {
    let visible = this.visibleTokens;
    let appending = true;
    let group = [];
    let groups = [group];
    let frontGroups = [];
    visible.forEach((token) =&gt; {
      if (token.front) {
        frontGroups.unshift(token);
      } else if (token.prepend) {
        if (appending) {
          appending = false;
          group = [];
          groups.push(group);
        }
        let lastToken = group[0];
        if (lastToken) {
          token = copy(token);
          token.separator = lastToken.separator;
        }
        group.unshift(token);
      } else {
        if (!appending) {
          appending = true;
          group = [];
          groups.push(group);
        }
        group.push(token);
      }
    });

    return frontGroups.concat(
      groups.reduce((E, group) =&gt; E.concat(group), [])
    );


  }

  toString() {
    let tokens = this.sortedTokens;

    return tokens
      .filter(token =&gt; Boolean(token.title))
      .map((token, index) =&gt; {
        if (index + 1 &lt; tokens.length) {
          return token.title + token.separator;
        }

        return token.title;
      })
      .join('');
  }

  /**
   * Remove any existing title tags from the head.
   * @private
   */
  _removeExistingTitleTag() {
    if (this._hasFastboot()) {
      return;
    }

    let titles = document.getElementsByTagName('title');
    for (let i = 0; i &lt; titles.length; i++) {
      let title = titles[i];
      title.parentNode.removeChild(title);
    }
  }

  _hasFastboot() {
    return !!getOwner(this).lookup('service:fastboot');
  }
}
</code></pre>
<pre><code class="language-js">// ember-page-title/addons/helpers/title

import { setOwner } from '@ember/application';
import { inject as service } from '@ember/service';
import { setHelperManager, capabilities } from '@ember/helper';

class TitleHelperManager {
  capabilities = capabilities('3.21', {
    hasScheduledEffect: true,
  });

  constructor(owner) {
    this.owner = owner;
  }

  createHelper(Title, args) {
    return new Title(this.owner, args);
  }

  runEffect(instance) {
    instance.update();
  }

  getDestroyable({ instance }) {
    registerDestructor(instance, () =&gt; instance.teardown());

    return instance;
  }
}


export default class Title {
  @service pageTitleList;

  constructor(owner, args) {
    setOwner(this, owner);
    this.args = args;
    this.pageTitleList.push({ id: guidFor(this) });
  }

  update() {
    let token = assign({}, this.args.named, {
      id: guidFor(this),
      title: this.args.positional.join(''),
    });

    this.pageTitleList.push(token);
  },

  teardown() {
    this.pageTitleList.remove(guidFor(this));
  }
}

setHelperManager((owner) =&gt; new EffectHelperManager(owner), Title);
</code></pre>
<pre><code class="language-hbs">{{title &quot;Blog&quot;}}
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="0617-rfc-stages.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="0626-invoke-helper.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a href="0617-rfc-stages.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a href="0626-invoke-helper.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
